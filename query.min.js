'use strict';class Query{constructor(sel=false,parent=false){this.regHTML=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;this.length=0;let that=this;this.nodes=new Proxy([],{get:function(tgt,prop){return tgt[prop]},set:function(tgt,prop,val){tgt[prop]=val;that.length=tgt.length;return true}});if(sel){this.select(sel,parent)}}select(sel,parent=false){let nodes=[];switch(this._type(sel)){case "string":parent=parent||document;if(parent.nodeType!=1){parent=document}let found=parent.querySelectorAll(sel);for(let i=0;i<found.length;i+=1){if(found[i].nodeType==1){nodes.push(found[i])}}break;case "node":nodes.push(sel);break}this._setNodes(nodes);return this}_type(elem){switch(typeof(elem)){case "string":let match=elem=this.regHTML.exec(elem);if(match){return "stringHTML"}else{return "string"}break;case "object":if(elem.nodeType==1){return "node"}else{return Object.prototype.toString.call(elem).replace(/^\[object (.+)\]$/,"$1").toLowerCase()}break}return false}before(html){this._attach(html,'beforebegin');return this}after(html){this._attach(html,'afterend');return this}start(html){this._attach(html,'afterbegin');return this}end(html){this._attach(html,'beforeend');return this}_attach(html,before){switch(this._type(html)){case "stringHTML":case "string":break;}this.nodes.forEach(function(node){node.insertAdjacentHTML(before,html)},this);this._execScripts(html)}_getNodesFromString(html){let nodes=[];let parsedNodes=new DOMParser().parseFromString(html,"text/html").querySelectorAll("body")[0].childNodes;for(let i=0;i<parsedNodes.length;i+=1){if(parsedNodes[i].nodeType==1){nodes.push(parsedNodes[i])}}return nodes}empty(){this.nodes.forEach(function(node){node.innerHTML=""});return this}html(html){this.nodes.forEach(function(node){node.innerHTML=html});this._execScripts(html);return this}_parseHTML(html){return new DOMParser().parseFromString(html,"text/html").querySelectorAll("body")[0].childNodes}prop(attr,val=false){this.nodes.forEach(function(node){if(val!==false){node.setAttribute(attr,val)}else{return node.getAttribute(attr)}});return this}each(func,domNode=false){this.nodes.forEach(function(node){func.apply(this,[domNode?node:new Query(node)])}.bind(this));return this}once(func,...params){func.apply(this,params);return this}listen(event,func,allowBubble=false){this.nodes.forEach(function(node){node.addEventListener(event,function(e){if(!allowBubble){e.stopPropagation()}func.apply(this,[new Query(node),e])})}.bind(this));return this}toggle(className){this.nodes.forEach(function(node){node.classList.toggle(className)});return this}addClass(className){this._class(className);return this}removeClass(className){this._class(className,true);return this}_class(className,remove=false){this.nodes.forEach(function(node){if(remove){node.classList.remove(className)}else{node.classList.add(className)}})}css(styles,value=false){let response=value?this:[];this.nodes.forEach(function(node){switch(this._type(styles)){case "string":if(!value){response.push(getComputedStyle(node)[styles])}else{node.style[styles]=value}break;case "object":for(let index in styles){node.style[index]=styles[index]}break}}.bind(this));return value?response:(this.nodes.length>1?response:response.join())}find(sel){let newNodes=[];this.nodes.forEach(function(node){let obj=node.querySelectorAll(sel);for(let index in obj){if(obj[index].nodeType==1){newNodes.push(obj[index])}}},this);this.nodes=newNodes;return this}parent(sel=false){let newNodes=[];this.nodes.forEach(function(node){let parent=node.parentNode;while(parent&&(parent.nodeType!=1||(sel?!parent.matches(sel):false))){parent=parent.parentNode}if(parent&&parent.nodeType==1){newNodes.push(parent)}});this._setNodes(newNodes);return this}_setNodes(nodes){this.nodes.length=0;nodes.forEach(function(node){if(!this.nodes.includes(node)){this.nodes.push(node)}},this)}_execScripts(html){let nodeList=[];switch(this._type(html)){case "stringHTML":case "string":nodeList=this._getNodesFromString(html);break;}nodeList.forEach(function(node){this._doScript(this._findScripts(node))},this)}_findScripts(node){let scripts=[];if(this._type(node)=="node"){if(node.localName=="script"){scripts.push(node.textContent)}else{let found=new Query("script",node);found.each(function(node){scripts.push(node.textContent)},true)}}return scripts}_doScript(sciptList){sciptList.forEach(function(code){let script=document.createElement("script");let head=document.getElementsByTagName("head")[0];script.appendChild(document.createTextNode(code));head.insertBefore(script,head.firstChild);head.removeChild(script)})}next(sel=false){this._sibling(true,sel);return this}prev(sel=false){this._sibling(false,sel);return this}_sibling(next,sel){let newNodes=[];this.nodes.forEach(function(node){let sibling=next?node.nextElementSibling:node.previousElementSibling;while(sibling&&(sibling.nodeType!=1||(sel?!sibling.matches(sel):true))){sibling=next?sibling.nextElementSibling:sibling.previousElementSibling}if(sibling&&sibling.nodeType==1){newNodes.push(sibling)}});this._setNodes(newNodes)}}
