'use strict';class Query{constructor(sel=false,parent=false){this.regHTML=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;this.length=0;let that=this;this.nodes=new Proxy([],{get:function(tgt,prop){return tgt[prop]},set:function(tgt,prop,val){tgt[prop]=val;that.length=tgt.length;return true}});if(sel){this.select(sel,parent)}}select(sel,parent=false){this._setNodes(this._select(sel,parent));return this}add(sel){let nodes=[];switch(this._type(sel)){case "string":nodes=this._select(sel);break;case "node":nodes=[sel];break;case "Query":sel.each(function(node){nodes.push(node)},true);break}this._setNodes(this.nodes.concat(nodes));return this}_select(sel,parent=false){let nodes=[];switch(this._type(sel)){case "string":parent=parent||document;if(parent.nodeType!=1){parent=document}let found=parent.querySelectorAll(sel);for(let i=0;i<found.length;i+=1){if(found[i].nodeType==1){nodes.push(found[i])}}break;case "node":nodes.push(sel);break;case "Query":sel.each(function(node){nodes.push(node)},true);break}return nodes}_type(elem){switch(typeof(elem)){case "string":let match=elem=this.regHTML.exec(elem);if(match){return "stringHTML"}else{return "string"}break;case "object":if(elem.nodeType==1){return "node"}else if(elem instanceof Query){return "Query"}else{return Object.prototype.toString.call(elem).replace(/^\[object (.+)\]$/,"$1").toLowerCase()}break}return false}before(html){this._attach(html,'beforebegin');return this}after(html){this._attach(html,'afterend');return this}start(html){this._attach(html,'afterbegin');return this}end(html){this._attach(html,'beforeend');return this}_attach(html,before){html=this._htmlString(html);this.nodes.forEach(function(node){node.insertAdjacentHTML(before,html)},this);this._execScripts(html)}_getNodesFromString(html){let nodes=[];let parsedNodes=new DOMParser().parseFromString(html,"text/html").querySelectorAll("body")[0].childNodes;for(let i=0;i<parsedNodes.length;i+=1){if(parsedNodes[i].nodeType==1){nodes.push(parsedNodes[i])}}return nodes}empty(){this.nodes.forEach(function(node){node.innerHTML=""});return this}html(html=false){let val='';if(html){html=this._htmlString(html)}this.nodes.forEach(function(node){if(html){node.innerHTML=html}else{val=node.innerHTML}});if(html){this._execScripts(html)}return html?this:val}_htmlString(html){switch(this._type(html)){case "node":html=html.outerHTML;break;case "Query":let temp="";html.each(function(node){temp+=node.outerHTML},true);html=temp;break}return html}prop(attr,val=false){let prop=undefined;this.nodes.forEach(function(node){if(val!==false){node.setAttribute(attr,val)}else{if(prop==undefined){prop=node.getAttribute(attr)}}});return val?this:(prop===undefined?"":prop)}each(func,domNode=false){this.nodes.forEach(function(node,index){func.apply(this,[domNode?node:new Query(node),index])}.bind(this));return this}once(func,...params){func.apply(this,params);return this}on(event,func,allowBubble=false){this.nodes.forEach(function(node){node.addEventListener(event,func)}.bind(this));return this}trigger(event){this.nodes.forEach(function(node){let ev=new Event(event);node.dispatchEvent(ev)});return this}off(event,func){this.nodes.forEach(function(node){node.removeEventListener(event,func)});return this}toggle(className){this.nodes.forEach(function(node){node.classList.toggle(className)});return this}addClass(className){this._class(className);return this}removeClass(className){this._class(className,true);return this}_class(className,remove=false){this.nodes.forEach(function(node){if(remove){node.classList.remove(className)}else{node.classList.add(className)}})}css(styles,value=false){let response=value?this:[];this.nodes.forEach(function(node){switch(this._type(styles)){case "string":if(!value){response.push(getComputedStyle(node)[styles])}else{node.style[styles]=value}break;case "object":for(let index in styles){node.style[index]=styles[index]}break}}.bind(this));return value?response:(this.nodes.length>1?response:response.join())}find(sel){let newNodes=[];this.nodes.forEach(function(node){let obj=node.querySelectorAll(sel);for(let index in obj){if(obj[index].nodeType==1){newNodes.push(obj[index])}}},this);this.nodes=newNodes;return this}parent(sel=false){let newNodes=[];this.nodes.forEach(function(node){let parent=false;if(sel&&node.closest){parent=node.closest(sel)}else{parent=node.parentNode;while(parent&&(parent.nodeType!=1||(sel?!this._matches(parent,sel):false))){parent=parent.parentNode}if(sel&&!this._matches(parent,sel)){parent=false}}if(parent&&parent.nodeType==1){newNodes.push(parent)}},this);this._setNodes(newNodes);return this}is(sel){let matched=false,selType=this._type(sel);this.nodes.forEach(function(node){if(!matched){switch(selType){case "string":matched=this._matches(node,sel);break;case "node":matched=node==sel;break;case "Query":sel.each(function(sel_node){if(!matched){matched=node==sel_node}},true);break}}},this);return matched}_matches(node,sel){if(Element.prototype.matches){return node.matches(sel)}if(!node){return false}let nodes=(node.parentNode||node.document).querySelectorAll(sel),i=-1;while(nodes[i+=1]&&nodes[i]!=node){};return!!nodes[i]}_setNodes(nodes){this.nodes.length=0;nodes.forEach(function(node){if(!this.nodes.includes(node)){this.nodes.push(node)}},this)}remove(){this.nodes.forEach(function(node){node.remove()},this);this._setNodes([]);return this}_execScripts(html){let nodeList=[];switch(this._type(html)){case "stringHTML":case "string":nodeList=this._getNodesFromString(html);break}nodeList.forEach(function(node){this._doScript(this._findScripts(node))},this)}_findScripts(node){let scripts=[];if(this._type(node)=="node"){if(node.localName=="script"){scripts.push(node.textContent)}else{let found=new Query("script",node);found.each(function(node){scripts.push(node.textContent)},true)}}return scripts}_doScript(sciptList){sciptList.forEach(function(code){let script=document.createElement("script");let head=document.getElementsByTagName("head")[0];script.appendChild(document.createTextNode(code));head.insertBefore(script,head.firstChild);head.removeChild(script)})}next(sel=false){this._sibling(true,sel);return this}prev(sel=false){this._sibling(false,sel);return this}_sibling(next,sel){let newNodes=[];this.nodes.forEach(function(node){let sibling=next?node.nextElementSibling:node.previousElementSibling;while(sibling&&(sibling.nodeType!=1||(sel?!this._matches(sibling,sel):true))){sibling=next?sibling.nextElementSibling:sibling.previousElementSibling}if(sibling&&sibling.nodeType==1){newNodes.push(sibling)}},this);this._setNodes(newNodes)}has(sel){let found=false;this.nodes.forEach(function(node){if(!found){found=node.querySelectorAll(sel).length>0}},this);return found}filter(test){let nodes=[];this.nodes.forEach(function(node){nodes.push(new Query(node))});let filtered=nodes.filter(test);let newNodes=[];filtered.forEach(function(node){newNodes.push(node)});this._setNodes(newNodes);return this}};
